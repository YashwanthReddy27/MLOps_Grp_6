name: Simple RAG Model CI/CD

on:
  push:
    branches:
      - fixes/model-ci-cd
      - main
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_LOCATION: 'us-central1'
  GCP_REPOSITORY: 'rag-models'

permissions:
  contents: write

jobs:
  evaluate-and-push:
    name: Evaluate Model & Push to Registry
    runs-on: ubuntu-latest
    environment: mlops
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with: 
          lfs: true
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r researchAI/model/requirements.txt

      - name: Download NLTK data
        run: |
          python -c "import nltk; nltk.download('punkt'); nltk.download('punkt_tab'); nltk.download('stopwords')"

      - name: Set up GCP credentials
        run: | 
          echo ' ${{ secrets.GCP_SA_DVC_KEY }}'  > gcp-key.json
          chmod 600 gcp-key.json
    
      - name: Configure DVC remote
        run: |
          dvc remote add -d -f myremote ${{ secrets.GCP_DVC_BUCKET }}
          dvc remote modify --local myremote credentialpath  "gcp-key.json"
  
      - name: DVC Pull
        run: | 
          cd researchAI
          ls -alth
          dvc pull

      - name: Check if data folder exists
        run: |
          if [ ! -d "researchAI/data/cleaned" ] || [ -z "$(ls -A researchAI/data/cleaned)" ]; then
            echo "âš ï¸ No data files found in cleaned folder. Nothing to index."
            echo "has_data=false" >> $GITHUB_OUTPUT
          else
            echo "âœ… Data folder exists with files. Proceeding with indexing..."
            echo "has_data=true" >> $GITHUB_OUTPUT
          fi
        id: check_data

      - name: Run Indexing Script
        if: steps.check_data.outputs.has_data == 'true'
        env:
          PYTHONPATH: ${{ github.workspace }}/researchAI/model
        run: |
          cd researchAI/model
          cd faiss_indexes
          ls -alth
          cd ..
          python indexing_script.py
          cd ../..
      
      # - name: DVC Push after Indexing
      #   if: steps.check_data.outputs.has_data == 'true'
      #   run: |
      #     cd researchAI
      #     chmod +x dvc/dvc.sh
      #     ./dvc/dvc.sh
      #   continue-on-error: false
      
      # - name: Dvc file add to git repo
      #   if: steps.check_data.outputs.has_data == 'true'
      #   run: |
      #     git config user.name "GitHub Actions Bot"
      #     git config user.email "actions@github.com"
      #     cd researchAI
      #     git add data.dvc
      #     git add logs.dvc
      #     git commit -m "Updated dvc ref"
      #     git push

      - name: Authenticate to Google Cloud
        if: steps.check_data.outputs.has_data == 'true'
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
        continue-on-error: true
      
      - name: Set up Google Cloud SDK
        if: steps.check_data.outputs.has_data == 'true'
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}
        continue-on-error: true
      
      - name: Run Complete Evaluation Pipeline
        if: steps.check_data.outputs.has_data == 'true'
        continue-on-error: true
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          PYTHONPATH: ${{ github.workspace }}/researchAI/model
        run: |
          cd researchAI/model
          
          PUSH_FLAG="--push-to-registry"
          echo "Will push to Artifact Registry if passed"
          
          python evaluation/simple_evaluate.py \
            --test-data test_queries_with_expected.csv \
            --output evaluation_report.json 
            $PUSH_FLAG \
            --project-id ${{ env.GCP_PROJECT_ID }} \
            --location ${{ env.GCP_LOCATION }} \
            --repository ${{ env.GCP_REPOSITORY }} \
            --version "v$(date +%Y%m%d-%H%M%S)"
          
          if [ -f artifact_path.txt ]; then
            cp artifact_path.txt ${{ github.workspace }}/artifact_path.txt
          fi
          cp evaluation_report.json ${{ github.workspace }}/evaluation_report.json
        id: evaluation

      - name: Check Evaluation Status
        if: steps.check_data.outputs.has_data == 'true'
        id: check_evaluation
        run: |
          if [ -f evaluation_report.json ]; then
            STATUS=$(jq -r '.aggregate_metrics.status' evaluation_report.json)
            echo "status=$STATUS" >> $GITHUB_OUTPUT
            if [ "$STATUS" = "FAILED" ]; then
              echo "âš ï¸ Model evaluation FAILED thresholds."
              echo "evaluation_passed=false" >> $GITHUB_OUTPUT
            else
              echo "âœ… Model evaluation PASSED thresholds."
              echo "evaluation_passed=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "evaluation_passed=false" >> $GITHUB_OUTPUT
            echo "status=FAILED" >> $GITHUB_OUTPUT
          fi

      - name: Push updated indexes to repository
        if: steps.check_data.outputs.has_data == 'true' && steps.check_evaluation.outputs.evaluation_passed == 'true'
        run: |
          git lfs install
          git lfs track "researchAI/model/bm25_indexes/**"
          git lfs track "researchAI/model/faiss_indexes/**"
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add .gitattributes
          git add researchAI/model/bm25_indexes/
          git add researchAI/model/faiss_indexes/
          echo "Staged changes:"
          git diff --staged --name-status
          git diff --staged --quiet || git commit -m "Update indexes after indexing [skip ci]"
          git lfs push origin ${{ github.ref_name }}
          git push
        
      - name: Upload evaluation report
        if: steps.check_data.outputs.has_data == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: evaluation-report
          path: evaluation_report.json 
          retention-days: 90

      - name: Read evaluation metrics
        if: steps.check_data.outputs.has_data == 'true'
        id: read_metrics
        run: |
          echo "ğŸ“ Current directory: $(pwd)"
          echo "ğŸ“‚ Looking for evaluation_report.json..."
          ls -la evaluation_report.json || echo "âŒ File not found!"
          
          if [ -f evaluation_report.json ]; then
            echo "âœ… File found, parsing..."
            
            STATUS=$(jq -r '.aggregate_metrics.status' evaluation_report.json)
            VALIDATION=$(jq -r '.aggregate_metrics.avg_validation_score' evaluation_report.json)
            FAIRNESS=$(jq -r '.aggregate_metrics.avg_fairness_score' evaluation_report.json)
            VAL_THRESHOLD=$(jq -r '.aggregate_metrics.thresholds.validation' evaluation_report.json)
            FAIR_THRESHOLD=$(jq -r '.aggregate_metrics.thresholds.fairness' evaluation_report.json)
            VAL_PASS_RATE=$(jq -r '.aggregate_metrics.validation_pass_rate' evaluation_report.json)
            FAIR_PASS_RATE=$(jq -r '.aggregate_metrics.fairness_pass_rate' evaluation_report.json)

            echo "ğŸ“Š Parsed Evaluation Metrics:"
            echo "  Status: $STATUS"
            echo "  Validation: $VALIDATION (threshold: $VAL_THRESHOLD)"
            echo "  Fairness: $FAIRNESS (threshold: $FAIR_THRESHOLD)"
            echo "  Validation Pass Rate: $VAL_PASS_RATE"
            echo "  Fairness Pass Rate: $FAIR_PASS_RATE"
            
            # Write to GITHUB_OUTPUT for step outputs
            echo "status=$STATUS" >> $GITHUB_OUTPUT
            echo "validation=${VALIDATION:-N/A}" >> $GITHUB_OUTPUT
            echo "fairness=${FAIRNESS:-N/A}" >> $GITHUB_OUTPUT
            echo "val_threshold=${VAL_THRESHOLD:-N/A}" >> $GITHUB_OUTPUT
            echo "fair_threshold=${FAIR_THRESHOLD:-N/A}" >> $GITHUB_OUTPUT
            echo "val_pass_rate=${VAL_PASS_RATE:-N/A}" >> $GITHUB_OUTPUT
            echo "fair_pass_rate=${FAIR_PASS_RATE:-N/A}" >> $GITHUB_OUTPUT
            
            # CRITICAL: Also write to GITHUB_ENV for email step
            echo "EVAL_STATUS=$STATUS" >> $GITHUB_ENV
            echo "EVAL_VALIDATION=${VALIDATION:-N/A}" >> $GITHUB_ENV
            echo "EVAL_FAIRNESS=${FAIRNESS:-N/A}" >> $GITHUB_ENV
            echo "EVAL_VAL_THRESHOLD=${VAL_THRESHOLD:-N/A}" >> $GITHUB_ENV
            echo "EVAL_FAIR_THRESHOLD=${FAIR_THRESHOLD:-N/A}" >> $GITHUB_ENV
            echo "EVAL_VAL_PASS_RATE=${VAL_PASS_RATE:-N/A}" >> $GITHUB_ENV
            echo "EVAL_FAIR_PASS_RATE=${FAIR_PASS_RATE:-N/A}" >> $GITHUB_ENV
            
            echo "âœ… Metrics saved to outputs and environment"
          else
            echo "âŒ evaluation_report.json not found"
            
            # Set fallback values
            echo "status=FAILED" >> $GITHUB_OUTPUT
            echo "validation=N/A" >> $GITHUB_OUTPUT
            echo "fairness=N/A" >> $GITHUB_OUTPUT
            echo "val_threshold=N/A" >> $GITHUB_OUTPUT
            echo "fair_threshold=N/A" >> $GITHUB_OUTPUT
            echo "val_pass_rate=N/A" >> $GITHUB_OUTPUT
            echo "fair_pass_rate=N/A" >> $GITHUB_OUTPUT
            
            # Also set in environment
            echo "EVAL_STATUS=FAILED" >> $GITHUB_ENV
            echo "EVAL_VALIDATION=N/A" >> $GITHUB_ENV
            echo "EVAL_FAIRNESS=N/A" >> $GITHUB_ENV
            echo "EVAL_VAL_THRESHOLD=N/A" >> $GITHUB_ENV
            echo "EVAL_FAIR_THRESHOLD=N/A" >> $GITHUB_ENV
            echo "EVAL_VAL_PASS_RATE=N/A" >> $GITHUB_ENV
            echo "EVAL_FAIR_PASS_RATE=N/A" >> $GITHUB_ENV
          fi

      - name: Send Failure Email
        if: |
          steps.check_data.outputs.has_data == 'true' && 
          steps.check_evaluation.outputs.evaluation_passed == 'false'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "âš ï¸ RAG Model Evaluation FAILED - ${{ github.ref_name }}"
          to: ${{ secrets.DEVELOPER_EMAIL }}
          from: RAG Model CI/CD
          body: |
            ğŸ”´ RAG Model Evaluation FAILED
            
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}
            Run: ${{ github.run_number }}
            
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            ğŸ“Š EVALUATION METRICS
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            
            Validation Score:
              â€¢ Achieved:  ${{ env.EVAL_VALIDATION }}
              â€¢ Required:  ${{ env.EVAL_VAL_THRESHOLD }}
              â€¢ Pass Rate: ${{ env.EVAL_VAL_PASS_RATE }}
            
            Fairness Score:
              â€¢ Achieved:  ${{ env.EVAL_FAIRNESS }}
              â€¢ Required:  ${{ env.EVAL_FAIR_THRESHOLD }}
              â€¢ Pass Rate: ${{ env.EVAL_FAIR_PASS_RATE }}
            
            Overall Status: ${{ env.EVAL_STATUS }}
            
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            ğŸ”— VIEW FULL DETAILS
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        continue-on-error: true