name: Auto Retrain on Health Issues

on:
  schedule:
    # Check every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GKE_CLUSTER: rag-cluster
  GKE_ZONE: us-central1-a

jobs:
  check-and-retrain:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Authenticate to GCP
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
    
    - name: Get GKE credentials
      run: |
        gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} \
          --zone=${{ env.GKE_ZONE }} \
          --project=${{ secrets.GCP_PROJECT_ID }}
    
    - name: Check model health
      id: health
      run: |
        BACKEND_IP=$(kubectl get service rag-backend -n rag-system -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
        
        HEALTH=$(curl -s http://${BACKEND_IP}:8000/api/monitor/health)
        echo "Health check result:"
        echo "$HEALTH"
        
        NEEDS_RETRAIN=$(echo "$HEALTH" | grep -o '"needs_retraining":[^,}]*' | sed 's/"needs_retraining"://' | tr -d ' ')
        
        echo "needs_retraining=$NEEDS_RETRAIN" >> $GITHUB_OUTPUT
        echo "$HEALTH" > health_report.json
    
    - name: Pull new data from GCS
      if: steps.health.outputs.needs_retraining == 'true'
      run: |
        echo "Model needs retraining - pulling latest data"
        gsutil -m rsync -r gs://${{ secrets.GCP_PROJECT_ID }}-mlops-data/cleaned ./data/cleaned || echo "No new data"
    
    - name: Set up Python
      if: steps.health.outputs.needs_retraining == 'true'
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Retrain model
      if: steps.health.outputs.needs_retraining == 'true'
      env:
        GEMINI_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
      run: |
        cd model
        pip install -r requirements.txt
        
        # Run indexing to update model
        python indexing_script.py
        
        echo " Model retrained"
    
    - name: Evaluate new model
      if: steps.health.outputs.needs_retraining == 'true'
      id: evaluate
      env:
        GEMINI_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
      run: |
        cd model
        
        python simple_evaluate.py \
          --test-data ../test_queries.csv \
          --validation-threshold 0.7 \
          --fairness-threshold 0.6 \
          --output new_evaluation.json
        
        STATUS=$(python -c "import json; print(json.load(open('new_evaluation.json'))['aggregate_metrics']['status'])")
        echo "new_model_status=$STATUS" >> $GITHUB_OUTPUT
    
    - name: Deploy if improved
      if: |
        steps.health.outputs.needs_retraining == 'true' &&
        steps.evaluate.outputs.new_model_status == 'PASSED'
      run: |
        echo "New model passed - triggering deployment"
        
        # Trigger main deployment workflow
        gh workflow run simple-deploy.yml
      env:
        GH_TOKEN: ${{ github.token }}
    
    - name: Send notification
      if: steps.health.outputs.needs_retraining == 'true'
      run: |
        STATUS="${{ steps.evaluate.outputs.new_model_status }}"
        
        if [ "$STATUS" = "PASSED" ]; then
          MESSAGE="✅ Model retrained successfully and deployed"
        else
          MESSAGE="⚠️ Model retrained but didn't pass validation - kept old model"
        fi
        
        echo "$MESSAGE"
        
        # Send to Slack (if webhook configured)
        if [ -n "${{ secrets.SLACK_WEBHOOK }}" ]; then
          curl -X POST ${{ secrets.SLACK_WEBHOOK }} \
            -H 'Content-Type: application/json' \
            -d "{\"text\":\"$MESSAGE\"}"
        fi
    
    - name: Create issue if failed
      if: |
        steps.health.outputs.needs_retraining == 'true' &&
        steps.evaluate.outputs.new_model_status == 'FAILED'
      uses: actions/github-script@v6
      with:
        script: |
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: '⚠️ Model Retraining Failed',
            body: 'Automated retraining was triggered but new model did not pass validation thresholds. Manual review required.',
            labels: ['monitoring', 'urgent']
          });