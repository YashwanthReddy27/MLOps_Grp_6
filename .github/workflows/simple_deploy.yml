name: Simple Deploy to GKE

on:
  push:
    branches: [ feature/UI+backend ]
  workflow_dispatch:

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GKE_CLUSTER: rag-cluster
  GKE_ZONE: us-central1-a

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Authenticate to GCP
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
    
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v1

    - name: Check if cluster exists
      id: check_cluster
      run: |
        if gcloud container clusters describe rag-cluster --zone=us-central1-a --project=$PROJECT_ID &>/dev/null; then
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "exists=false" >> $GITHUB_OUTPUT
        fi

    - name: Create GKE cluster
      if: steps.check_cluster.outputs.exists == 'false'
      run: |
        gcloud container clusters create rag-cluster \
          --zone us-central1-a \
          --num-nodes 2 \
          --machine-type n1-standard-2 \
          --disk-size 50 \
          --enable-autoscaling \
          --min-nodes 2 \
          --max-nodes 4 \
          --scopes=https://www.googleapis.com/auth/cloud-platform \
          --project $PROJECT_ID

    - name: Configure Docker
      run: |
        gcloud auth configure-docker us-central1-docker.pkg.dev

    - name: Deploy to namespace to Kubernetes
      run: |
        kubectl apply -f k8s/namespace.yaml

    - name: Build and Push Frontend
      run: |
        cd frontend
        docker buildx build --platform linux/amd64 -t us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/rag-docker/frontend:latest . --push
    
    - name: Build and Push Backend
      run: |
        cd researchAI/model
        docker buildx build --platform linux/amd64 -t us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/backend:latest . --push
    
    - name: Get GKE Credentials
      run: |
        gcloud container clusters get-credentials ${{ secrets.GKE_CLUSTER }} \
          --zone=${{ secrets.GKE_ZONE }} \
          --project=${{ secrets.GCP_PROJECT_ID }}

    - name: Delete the existing deployment if any
      run: |
        kubectl delete deployment rag-frontend rag-backend -n rag-system
        
    - name: Deploy to Kubernetes
      run: |
        kubectl apply -f k8s/backend.yaml
        kubectl apply -f k8s/frontend.yaml
    
    - name: Wait for deployment
      run: |
        kubectl wait --for=condition=available --timeout=300s \
          deployment/rag-backend -n rag-system
        kubectl wait --for=condition=available --timeout=300s \
          deployment/rag-frontend -n rag-system

    - name: Check pod status
      run: |
        kubectl get pods -n rag-system
    
    - name: Get service URLs
      run: |
        echo "Backend URL:"
        kubectl get service rag-backend -n rag-system
        echo "Frontend URL:"
        kubectl get service rag-frontend -n rag-system