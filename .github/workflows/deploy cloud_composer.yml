name: Deploy Cloud Composer

on:
  push: 
    branches:
      # - main
  workflow_dispatch:

jobs:
  deployCloudComposer:
    name: Deploy Cloud Composer
    runs-on: ubuntu-latest
    environment: mlops

    env:
      PYTHON_VERSION: '3.11'
      COMPOSER_ENV: "rag-environment"
      COMPOSER_REGION: "us-east1"

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_DVC_KEY }}

    - name: Set up gcloud CLI
      uses: google-github-actions/setup-gcloud@v2

    - name: Run terraform config
      run: |
        sudo snap install terraform --classic
        cd researchAI/k8s
        terraform init
        chmod +x ./terraform.sh
        ./terraform.sh
      continue-on-error: true

    - name: Run Terraform apply
      run: |
        cd researchAI/k8s
        terraform apply -auto-approve
      continue-on-error: true

    - name: verify deployment
      run: |
        if gcloud composer environments describe "rag-environment" \
          --project="mlops-gcp-lab1" \
          --location="us-east1" >/dev/null 2>&1; then
          echo "Composer environment exists."
        else
          echo "Composer environment does NOT exist."
          exit 1
        fi
      continue-on-error: false
